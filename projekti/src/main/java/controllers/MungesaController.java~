package controllers;

import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.chart.PieChart;
import javafx.scene.control.*;
import javafx.scene.input.MouseEvent;

import java.io.FileWriter;
import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;
import java.util.Timer;
import java.util.TimerTask;

public class MungesaController {

    @FXML
    private TextField txtKerkim, txtStudenti, txtLenda, txtKlasa, txtArsyeja;
    @FXML
    private DatePicker datePicker;
    @FXML
    private ListView<String> listaMungesave;
    @FXML
    private Label lblTotalJave, lblTotalMuaj, lblNxenesiMeShumeMungesa, lblOra, lblData;
    @FXML
    private PieChart pieChart;

    // Lista që do të përmbajë mungesat dhe statistikat
    private ObservableList<String> mungesat = FXCollections.observableArrayList();
    private Map<String, Integer> statistika = new HashMap<>();

    @FXML
    public void initialize() {
        // Orë dhe Datë që përditësohen automatikisht
        startClock();

        // Vendos listën e mungesave në ListView
        listaMungesave.setItems(mungesat);

        // Inicimi i PieChart
        pieChart.setTitle("Statistikat e Mungesave");
    }

    @FXML
    private void regjistroMungese(ActionEvent actionEvent) {
        String emri = txtStudenti.getText();
        String lenda = txtLenda.getText();
        String klasa = txtKlasa.getText();
        LocalDate data = datePicker.getValue();
        String arsyeja = txtArsyeja.getText();

        if (!emri.isEmpty() && data != null) {
            String raport = "Nxënësi: " + emri + " | Lënda: " + lenda + " | Klasa: " + klasa + " | Data: " + data + " | Arsyeja: " + arsyeja;
            mungesat.add(raport);
            listaMungesave.setItems(mungesat);

            // Përditëso statistikat
            statistika.put(emri, statistika.getOrDefault(emri, 0) + 1);
            lblTotalJave.setText("Total Mungesa (Javore): " + mungesat.size());
            lblTotalMuaj.setText("Total Mungesa (Mujore): " + mungesat.size());

            // Përditëso grafikun
            updateChart();

            // Gjetja e nxënësit me më shumë mungesa
            String maxStudent = statistika.entrySet().stream()
                    .max(Map.Entry.comparingByValue())
                    .map(Map.Entry::getKey)
                    .orElse("-");
            lblNxenesiMeShumeMungesa.setText("Nxënësi me më shumë mungesa: " + maxStudent);

            pastroFushat();
        } else {
            showError("Ju lutem plotësoni të gjitha fushat dhe datën!");
        }
    }

    @FXML
    private void pastroFushat() {
        txtStudenti.clear();
        txtLenda.clear();
        txtKlasa.clear();
        txtArsyeja.clear();
        datePicker.setValue(null);
    }

    private void showError(String message) {
        Alert alert = new Alert(Alert.AlertType.ERROR);
        alert.setTitle("Gabim");
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }

    @FXML
    public void printoRaportin(ActionEvent actionEvent) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("Printim i Raportit");
        alert.setHeaderText(null);
        alert.setContentText("Raporti i mungesave u printua me sukses!");
        alert.showAndWait();
    }

    @FXML
    public void eksportoExcel(ActionEvent actionEvent) {
        try (FileWriter writer = new FileWriter("Mungesat.csv")) {
            writer.append("Emri, Lënda, Klasa, Data, Arsyeja\n");
            for (String raport : mungesat) {
                writer.append(raport.replace(" | ", ", ").replace("Nxënësi: ", "").replace("Lënda: ", "").replace("Klasa: ", "").replace("Data: ", "").replace("Arsyeja: ", ""));
                writer.append("\n");
            }
            Alert alert = new Alert(Alert.AlertType.INFORMATION);
            alert.setTitle("Eksportim në Excel");
            alert.setHeaderText(null);
            alert.setContentText("Lista e mungesave u eksportua me sukses në Mungesat.csv!");
            alert.showAndWait();
        } catch (IOException e) {
            showError("Gabim gjatë eksportimit në Excel!");
        }
    }

    public void shfaqGrafikun(ActionEvent actionEvent) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("Grafiku");
        alert.setHeaderText(null);
        alert.setContentText("Grafiku i mungesave është duke u ndërtuar.");
        alert.showAndWait();
    }

    // Metoda për të përditësuar orën dhe datën
    private void startClock() {
        Timer timer = new Timer();
        DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("HH:mm:ss");
        DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("dd-MM-yyyy");

        timer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                Platform.runLater(() -> {
                    lblOra.setText("Ora: " + LocalTime.now().format(timeFormatter));
                    lblData.setText("Data: " + LocalDate.now().format(dateFormatter));
                });
            }
        }, 0, 1000);
    }

    // Metoda për përditësimin e grafikut
    private void updateChart() {
        ObservableList<PieChart.Data> chartData = FXCollections.observableArrayList();
        for (Map.Entry<String, Integer> entry : statistika.entrySet()) {
            chartData.add(new PieChart.Data(entry.getKey(), entry.getValue()));
        }
        pieChart.setData(chartData);
    }
}
