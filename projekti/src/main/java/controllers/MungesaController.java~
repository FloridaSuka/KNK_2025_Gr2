package controllers;

import database.DBConnector;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import models.Mungesa;
import repositories.*;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.SQLException;

public class MungesaController {

    @FXML private TextField txtId;
    @FXML private TextField txtNxenesi;
    @FXML private TextField txtLenda;
    @FXML private TextField txtPerioda;
    @FXML private TextField txtArsyeja;

    private final MungesatRepository mungesaRepo = new MungesatRepository();
    private final NxenesitRepository nxenesiRepo = new NxenesitRepository();
    private final LendaRepository lendaRepo = new LendaRepository();
    private final PeriodaRepository periodaRepo = new PeriodaRepository();

     @FXML
    public boolean shtoMungese(Mungesa m) {
        String sql = "INSERT INTO Mungesa(student_id, lenda_id, perioda_id, data_mungeses, arsyeja) VALUES (?, ?, ?, ?, ?)";
        try (Connection conn = DBConnector.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {

            stmt.setInt(1, m.getStudentId());
            stmt.setInt(2, m.getLendaId());
            stmt.setInt(3, m.getPeriodaId());
            stmt.setDate(4, m.getDataMungeses());
            stmt.setString(5, m.getArsyeja());

            return stmt.executeUpdate() > 0;
        } catch (SQLException e) {
            e.printStackTrace();
            return false;
        }
    }

    @FXML
    private void perditesoMungese() {
        if (txtId.getText().isEmpty()) {
            shfaqAlert("Gabim", "ID mungon", "Ju lutem shkruani ID për të përditësuar.", Alert.AlertType.WARNING);
            return;
        }

        Integer studentId = nxenesiRepo.getNxenesiIdByName(txtNxenesi.getText().trim());
        Integer lendaId = lendaRepo.getLendaIdByName(txtLenda.getText().trim());
        Integer periodaId = periodaRepo.getPeriodaIdByName(txtPerioda.getText().trim());

        if (studentId == null || lendaId == null || periodaId == null) {
            shfaqAlert("Gabim", "Të dhënat janë të paplota", "Sigurohuni që emrat ekzistojnë dhe data është zgjedhur.", Alert.AlertType.ERROR);
            return;
        }

        int id = Integer.parseInt(txtId.getText());
        Mungesa m = new Mungesa(id, studentId, lendaId, periodaId, new Date(System.currentTimeMillis()), txtArsyeja.getText());
        boolean success = mungesaRepo.perditeso(id, studentId, lendaId, periodaId, new Date(System.currentTimeMillis()), txtArsyeja.getText());

        if (success) {
            shfaqAlert("Sukses", "U përditësua", "Të dhënat u përditësuan me sukses.", Alert.AlertType.INFORMATION);
        } else {
            shfaqAlert("Gabim", "Dështoi përditësimi", "Nuk u arrit të përditësohen të dhënat.", Alert.AlertType.ERROR);
        }
    }

    @FXML
    private void fshijMungese() {
        if (txtId.getText().isEmpty()) {
            shfaqAlert("Gabim", "ID mungon", "Ju lutem shkruani ID për të fshirë.", Alert.AlertType.WARNING);
            return;
        }

        int id = Integer.parseInt(txtId.getText());
        boolean success = mungesaRepo.fshij(id);

        if (success) {
            shfaqAlert("Sukses", "Fshirja u krye", "Mungesa u fshi me sukses.", Alert.AlertType.INFORMATION);
        } else {
            shfaqAlert("Gabim", "Dështoi fshirja", "Nuk u arrit të fshihet mungesa.", Alert.AlertType.ERROR);
        }
    }

    private void shfaqAlert(String titulli, String header, String mesazhi, Alert.AlertType tipi) {
        Alert alert = new Alert(tipi);
        alert.setTitle(titulli);
        alert.setHeaderText(header);
        alert.setContentText(mesazhi);
        alert.showAndWait();
    }
}
